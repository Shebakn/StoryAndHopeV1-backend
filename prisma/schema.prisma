generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum UserRole {
  DONOR
  ADMIN
  ORG_MANAGER
}

enum CasePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CaseStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum DonationStatus {
  PENDING
  SUCCESS
  PAID
  FAILED
  REFUNDED
}

enum MediaType {
  IMAGE
  VIDEO
}

//////////////////////////////////////////////////////
// USERS
//////////////////////////////////////////////////////

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  phone         String?
  passwordHash  String?
  role          UserRole  @default(DONOR)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
 
 uploadedMedia  CaseMedia[] @relation("UserMedia")
 
  donations     Donation[]
  refunds       Refund[]  @relation("RefundProcessedBy")
}

//////////////////////////////////////////////////////
// ORGANIZATIONS
//////////////////////////////////////////////////////

model Organization {
  id            String   @id @default(uuid())
  name          String
  description   String?
  website       String?
  logoUrl       String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  cases         Case[]
  paymentMethods PaymentMethod[]
  donations     Donation[]
}

//////////////////////////////////////////////////////
// PAYMENT METHODS
//////////////////////////////////////////////////////

model PaymentMethod {
  id              String   @id @default(uuid())
  organizationId  String
  name            String
  provider        String
  walletAddress   String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  donations       Donation[]

  @@index([organizationId])
}

//////////////////////////////////////////////////////
// CASE TYPES
//////////////////////////////////////////////////////

model CaseType {
  id      String @id @default(uuid())
  name    String @unique // STORY / APPEAL / FUTURE TYPES

  cases   Case[]
  categories Category[]
}

//////////////////////////////////////////////////////
// CATEGORIES
//////////////////////////////////////////////////////

model Category {
  id          String       @id @default(uuid())
  name        String       @unique
  caseTypeId  String
  caseType    CaseType     @relation(fields: [caseTypeId], references: [id])

  caseCategories CaseCategory[]
}

//////////////////////////////////////////////////////
// CASES
//////////////////////////////////////////////////////

//////////////////////////////////////////////////////
// CASES (القصص والمناشدات)
//////////////////////////////////////////////////////

model Case {
  id              String      @id @default(uuid())

  // Cover relation (الصورة الرئيسية)
  coverMediaId    String?  @unique
  coverMedia      CaseMedia?  @relation("CaseCover", fields: [coverMediaId], references: [id])

  organizationId  String
  caseTypeId      String

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  caseType        CaseType     @relation(fields: [caseTypeId], references: [id])

  // العلاقات
  donations       Donation[]
  media           CaseMedia[]
  caseCategories  CaseCategory[]

  // المعلومات الأساسية
  title           String
  shortDescription String
  fullDescription  String

  // ✅ أهداف الحملة - مصفوفة نصوص بسيطة
  goals           String[]     // مثال: ["توفير سلة غذائية", "شراء أدوية", "ملابس شتوية"]

  // الأهداف المالية (إجمالي)
  goalAmount      Decimal     @db.Decimal(12,2)
  raisedAmount    Decimal     @default(0) @db.Decimal(12,2)

  // معلومات إضافية
  location        String
  priority        CasePriority @default(MEDIUM)
  isUrgent        Boolean     @default(false)
  isFeatured      Boolean     @default(false)
  status          CaseStatus  @default(DRAFT)

  // معلومات الطفل/المستفيد
  beneficiaryName    String?   // اسم المستفيد
  beneficiaryAge     Int?      // عمر المستفيد
  beneficiaryStory   String?   // قصة المستفيد (اختصار)

  // تواريخ
  startDate       DateTime?   // تاريخ بدء الحملة
  endDate         DateTime?   // تاريخ انتهاء الحملة (اختياري)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Indexes للتحسين الأداء
  @@index([organizationId])
  @@index([caseTypeId])
  @@index([priority])
  @@index([status])
  @@index([isUrgent])
  @@index([isFeatured])
  @@index([location])
  @@index([coverMediaId])
  @@index([startDate])
  @@index([endDate])
}

//////////////////////////////////////////////////////
// MANY-TO-MANY: CASE ↔ CATEGORY
//////////////////////////////////////////////////////

model CaseCategory {
  caseId      String
  categoryId  String

  case        Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([caseId, categoryId])
}

//////////////////////////////////////////////////////
// MEDIA
//////////////////////////////////////////////////////

model CaseMedia {
  id     String @id @default(uuid())
  caseId String

  // العلاقة الرئيسية مع Case
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  // علاقة "الصورة الغلافية" العكسية من Case
  caseCover Case? @relation("CaseCover") 

  publicId  String? // معرف الملف في التخزين السحابي
  url       String  // رابط الملف
  type      MediaType
  format    String? // png, jpg, mp4, etc.
  bytes     Int?    // حجم الملف بالبايت
  order     Int     @default(0) // ترتيب العرض
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // العلاقة مع المستخدم (اختياري)
  uploadedById String?
  uploadedBy   User? @relation("UserMedia", fields: [uploadedById], references: [id])

  @@unique([caseId, order])
  @@index([caseId])
  @@index([uploadedById])
}

//////////////////////////////////////////////////////
// DONATIONS
//////////////////////////////////////////////////////

model Donation {
  id               String         @id @default(uuid())
  userId           String?
  caseId           String
  organizationId   String
  paymentMethodId  String?

  amount           Decimal        @db.Decimal(12,2)
  status           DonationStatus @default(PENDING)
  transactionRef   String?
  createdAt        DateTime       @default(now())

  user             User?          @relation(fields: [userId], references: [id])
  case             Case           @relation(fields: [caseId], references: [id], onDelete: Cascade)
  organization     Organization   @relation(fields: [organizationId], references: [id])
  paymentMethod    PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  invoice          Invoice?
  refunds          Refund[]
  logs             TransactionLog[]

  @@index([caseId])
  @@index([organizationId])
  @@index([userId])
  @@index([status])
}

//////////////////////////////////////////////////////
// INVOICES
//////////////////////////////////////////////////////

model Invoice {
  id            String   @id @default(uuid())
  donationId    String   @unique
  invoiceNumber String   @unique
  subtotal      Decimal  @db.Decimal(12,2)
  fees          Decimal  @default(0) @db.Decimal(12,2)
  total         Decimal  @db.Decimal(12,2)
  currency      String
  issuedAt      DateTime @default(now())

  donation      Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// REFUNDS
//////////////////////////////////////////////////////

model Refund {
  id            String   @id @default(uuid())
  donationId    String
  processedById String?
  amount        Decimal  @db.Decimal(12,2)
  reason        String?
  refundedAt    DateTime @default(now())

  donation      Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)
  processedBy   User?    @relation("RefundProcessedBy", fields: [processedById], references: [id])

  @@index([donationId])
}

//////////////////////////////////////////////////////
// TRANSACTION LOGS
//////////////////////////////////////////////////////

model TransactionLog {
  id          String         @id @default(uuid())
  donationId  String
  oldStatus   DonationStatus
  newStatus   DonationStatus
  changedAt   DateTime       @default(now())

  donation    Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)

  @@index([donationId])
}
